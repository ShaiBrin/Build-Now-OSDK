{"version":3,"file":"createRetryingFetch.js","names":["PalantirApiError","fetchRetry","INITIAL_DELAY","JITTER_FACTOR","MAX_RETRIES","createRetryingFetch","fetch","retryDelay","attempt","delay","jitter","Math","random","retryOn","error","response","status","isRetryable","e","statusCode","SERVICE_UNAVAILABLE","TOO_MANY_REQUESTS"],"sources":["createRetryingFetch.js"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { PalantirApiError } from \"@osdk/shared.net.errors\";\nimport fetchRetry from \"fetch-retry\";\nconst INITIAL_DELAY = 1_000;\nconst JITTER_FACTOR = 0.5;\nconst MAX_RETRIES = 3;\nexport function createRetryingFetch(fetch) {\n    return fetchRetry(fetch, {\n        retryDelay(attempt) {\n            const delay = INITIAL_DELAY * 2 ** attempt;\n            const jitter = delay * JITTER_FACTOR * (Math.random() * 2 - 1);\n            return delay + jitter;\n        },\n        retryOn(attempt, error, response) {\n            const status = response?.status ?? 0;\n            return (!(status >= 200 && status < 300)\n                && isRetryable(error)\n                && attempt < MAX_RETRIES);\n        },\n    });\n}\nfunction isRetryable(e) {\n    if (e instanceof PalantirApiError) {\n        if (e.statusCode !== SERVICE_UNAVAILABLE\n            && e.statusCode !== TOO_MANY_REQUESTS) {\n            return false;\n        }\n    }\n    return true; // I think this logic is flawed?\n}\nconst SERVICE_UNAVAILABLE = 503;\nconst TOO_MANY_REQUESTS = 429;\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASA,gBAAgB,QAAQ,yBAAyB;AAC1D,OAAOC,UAAU,MAAM,aAAa;AACpC,MAAMC,aAAa,GAAG,KAAK;AAC3B,MAAMC,aAAa,GAAG,GAAG;AACzB,MAAMC,WAAW,GAAG,CAAC;AACrB,OAAO,SAASC,mBAAmBA,CAACC,KAAK,EAAE;EACvC,OAAOL,UAAU,CAACK,KAAK,EAAE;IACrBC,UAAUA,CAACC,OAAO,EAAE;MAChB,MAAMC,KAAK,GAAGP,aAAa,GAAG,CAAC,IAAIM,OAAO;MAC1C,MAAME,MAAM,GAAGD,KAAK,GAAGN,aAAa,IAAIQ,IAAI,CAACC,MAAM,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;MAC9D,OAAOH,KAAK,GAAGC,MAAM;IACzB,CAAC;IACDG,OAAOA,CAACL,OAAO,EAAEM,KAAK,EAAEC,QAAQ,EAAE;MAC9B,MAAMC,MAAM,GAAGD,QAAQ,EAAEC,MAAM,IAAI,CAAC;MACpC,OAAQ,EAAEA,MAAM,IAAI,GAAG,IAAIA,MAAM,GAAG,GAAG,CAAC,IACjCC,WAAW,CAACH,KAAK,CAAC,IAClBN,OAAO,GAAGJ,WAAW;IAChC;EACJ,CAAC,CAAC;AACN;AACA,SAASa,WAAWA,CAACC,CAAC,EAAE;EACpB,IAAIA,CAAC,YAAYlB,gBAAgB,EAAE;IAC/B,IAAIkB,CAAC,CAACC,UAAU,KAAKC,mBAAmB,IACjCF,CAAC,CAACC,UAAU,KAAKE,iBAAiB,EAAE;MACvC,OAAO,KAAK;IAChB;EACJ;EACA,OAAO,IAAI,CAAC,CAAC;AACjB;AACA,MAAMD,mBAAmB,GAAG,GAAG;AAC/B,MAAMC,iBAAiB,GAAG,GAAG","ignoreList":[]}