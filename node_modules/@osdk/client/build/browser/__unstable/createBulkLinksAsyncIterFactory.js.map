{"version":3,"file":"createBulkLinksAsyncIterFactory.js","names":["getBulkLinksPage","invariant","conjureUnionType","makeConjureContext","applyPageToken","getResults","pageRequestAsAsyncIter","metadataCacheClient","createBulkLinksAsyncIterFactory","ctx","objs","linkTypes","length","logger","debug","every","a","$objectType","process","env","NODE_ENV","mcc","helper","forObjectByApiName","objectTypeRid","propertyMapping","fullLinkMapping","Promise","all","getRid","getPropertyMapping","getLinkMapping","linkMapping","Object","fromEntries","entries","filter","apiName","includes","linkType","req","objectSetContext","forkRid","undefined","objectSetFilterContext","parameterOverrides","ontologyBranchRid","owningRid","reportUsage","workstateRid","responseOptions","includeObjectSetEntities","includeUsageCost","pageSize","pageToken","linksRequests","directedLinkTypes","values","map","directedLinkTypeRid","objects","o","objectPrimaryKey","pk","rid","type","$primaryKey","bulkLinksIter","bind","item","objectIdentifier","obj","findObject","link","links","ref","linkSide","getPrimaryKeyOrThrow","otherObjectApiName","forObjectByRid","getApiName","mappedLink","find","linkTypeRid","Error","object","linkApiName","otherObjectPk","pkValue","pks","objectLocatorV2"],"sources":["createBulkLinksAsyncIterFactory.js"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { getBulkLinksPage } from \"@osdk/client.unstable\";\nimport invariant from \"tiny-invariant\";\nimport { conjureUnionType } from \"../objectSet/conjureUnionType.js\";\nimport { makeConjureContext } from \"../ontology/makeConjureContext.js\";\nimport { applyPageToken, getResults, pageRequestAsAsyncIter, } from \"../pageRequestAsAsyncIter.js\";\nimport { metadataCacheClient } from \"./ConjureSupport.js\";\nexport function createBulkLinksAsyncIterFactory(ctx) {\n    return async function* (objs, linkTypes) {\n        if (objs.length === 0) {\n            return;\n        }\n        ctx.logger?.debug(\"Preparing to fetch bulk links\");\n        // require all objects to be the same type for now\n        invariant(objs.every(a => a.$objectType === objs[0].$objectType));\n        const mcc = await metadataCacheClient(ctx);\n        const helper = await mcc.forObjectByApiName(objs[0].$objectType);\n        const [objectTypeRid, propertyMapping, fullLinkMapping] = await Promise.all([\n            helper.getRid(),\n            helper.getPropertyMapping(),\n            helper.getLinkMapping(),\n        ]);\n        const linkMapping = Object.fromEntries(Object.entries(fullLinkMapping)\n            .filter(([apiName]) => linkTypes.includes(apiName)));\n        // make sure the link being requested exists\n        for (const linkType of linkTypes) {\n            if (linkMapping[linkType] == null) {\n                throw \"Unable to find link type: \" + linkType;\n            }\n        }\n        const req = {\n            objectSetContext: {\n                forkRid: undefined,\n                objectSetFilterContext: { parameterOverrides: {} },\n                ontologyBranchRid: undefined,\n                owningRid: undefined,\n                reportUsage: undefined,\n                workstateRid: undefined,\n            },\n            responseOptions: {\n                includeObjectSetEntities: true,\n                includeUsageCost: false,\n            },\n            pageSize: 1000,\n            pageToken: undefined,\n            linksRequests: [{\n                    directedLinkTypes: Object.values(linkMapping)\n                        .map(({ directedLinkTypeRid }) => directedLinkTypeRid),\n                    objects: conjureUnionType(\"objects\", objs.map(o => conjureUnionType(\"objectLocatorV2\", {\n                        objectTypeRid,\n                        objectPrimaryKey: {\n                            [propertyMapping.pk.rid]: conjureUnionType(propertyMapping.pk.type.type, o.$primaryKey),\n                        },\n                    }))),\n                }],\n        };\n        const bulkLinksIter = pageRequestAsAsyncIter(getBulkLinksPage.bind(undefined, makeConjureContext(ctx, \"/object-set-service/api\")), getResults, applyPageToken, req);\n        for await (const item of bulkLinksIter) {\n            const { objectIdentifier } = item;\n            const obj = findObject(objectIdentifier, objs);\n            for (const link of item.links) {\n                const ref = link.link[link.linkSide === \"SOURCE\"\n                    ? \"objectSideB\"\n                    : \"objectSideA\"];\n                const pk = getPrimaryKeyOrThrow(ref);\n                const otherObjectApiName = await (await mcc.forObjectByRid(pk.objectTypeRid))\n                    .getApiName();\n                const mappedLink = Object.values(linkMapping).find(a => a.directedLinkTypeRid.linkTypeRid === link.link.linkTypeRid\n                    && a.directedLinkTypeRid.linkSide === link.linkSide);\n                if (!mappedLink)\n                    throw new Error(\"Could not find link type\"); // should not happens\n                yield {\n                    object: obj,\n                    linkApiName: mappedLink.apiName,\n                    otherObjectApiName: otherObjectApiName,\n                    otherObjectPk: pk.pkValue,\n                };\n            }\n        }\n    };\n}\nfunction findObject(objectIdentifier, objs) {\n    const { pkValue } = getPrimaryKeyOrThrow(objectIdentifier);\n    const obj = objs.find(o => o.$primaryKey === pkValue);\n    if (obj == null) {\n        throw new Error(`Needed to find object with pk ${pkValue}} and could not`);\n    }\n    return obj;\n}\nfunction getPrimaryKeyOrThrow(ref) {\n    if (\"type\" in ref && ref.type !== \"objectLocatorV2\") {\n        throw new Error(\"We do not support looking up object by rid\");\n    }\n    const pks = Object.entries(ref.objectLocatorV2.objectPrimaryKey);\n    if (pks.length !== 1) {\n        throw new Error(\"Unable to support this request due to multiple pks\");\n    }\n    return {\n        objectTypeRid: ref.objectLocatorV2.objectTypeRid,\n        pkValue: pks[0][1][pks[0][1].type],\n    };\n}\n"],"mappings":"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","ignoreList":[]}