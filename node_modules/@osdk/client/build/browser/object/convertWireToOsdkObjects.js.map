{"version":3,"file":"convertWireToOsdkObjects.js","names":["invariant","createOsdkObject","convertWireToOsdkObjects","client","objects","interfaceApiName","forceRemoveRid","selectedProps","strictNonNull","logger","debug","fixObjectPropertiesInPlace","ifaceDef","ontologyProvider","getInterfaceDefinition","undefined","ifaceSelected","Object","keys","properties","ret","rawObj","objectDef","getObjectDefinition","$apiName","process","env","NODE_ENV","objProps","conforming","invariantInterfacesAsViews","apiName","isConforming","reframeAsObjectInPlace","convertInterfacePropNamesToObjectPropNames","Error","osdkObject","$as","push","ifacePropsToMap","map","ifaceProp","interfaceMap","newProps","sptProp","regularProp","entries","value","assign","primaryKeyApiName","$primaryKey","def","obj","propsToCheck","propName","nullable","$objectType","warning","warn","console","error","objs","__rid","$rid","__apiName","__primaryKey","$title","__title"],"sources":["convertWireToOsdkObjects.js"],"sourcesContent":["/*\n * Copyright 2023 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport invariant from \"tiny-invariant\";\nimport { createOsdkObject } from \"./convertWireToOsdkObjects/createOsdkObject.js\";\n/**\n * If interfaceApiName is not undefined, converts the instances of the\n * interface into their respective\n * underlying concrete types and then returns the $as() representation\n * for the consumers.\n *\n * Otherwise just does the conversion\n *\n * May mutate in place for performance reasons. If you need a clean copy,\n * keep it first.\n *\n * However, you must use the returned value, which will be whatever is correct.\n *\n * @internal\n * @param interfaceApiName - if undefined\n */\nexport async function convertWireToOsdkObjects(client, objects, interfaceApiName, forceRemoveRid = false, selectedProps, strictNonNull = false) {\n    client.logger?.debug(`START convertWireToOsdkObjects()`);\n    fixObjectPropertiesInPlace(objects, forceRemoveRid);\n    const ifaceDef = interfaceApiName\n        ? await client.ontologyProvider.getInterfaceDefinition(interfaceApiName)\n        : undefined;\n    const ifaceSelected = ifaceDef\n        ? (selectedProps ?? Object.keys(ifaceDef.properties))\n        : undefined;\n    const ret = [];\n    for (const rawObj of objects) {\n        const objectDef = await client.ontologyProvider.getObjectDefinition(rawObj.$apiName);\n        invariant(objectDef, `Missing definition for '${rawObj.$apiName}'`);\n        // default value for when we are checking an object\n        let objProps;\n        let conforming = true;\n        if (ifaceDef && ifaceSelected) {\n            // API returns interface spt names but we cache by real values\n            invariantInterfacesAsViews(objectDef, ifaceDef.apiName, client);\n            conforming &&= isConforming(client, ifaceDef, rawObj, ifaceSelected);\n            reframeAsObjectInPlace(objectDef, ifaceDef.apiName, rawObj);\n            objProps = convertInterfacePropNamesToObjectPropNames(objectDef, ifaceDef.apiName, ifaceSelected);\n        }\n        else {\n            objProps = selectedProps ?? Object.keys(objectDef.properties);\n        }\n        conforming &&= isConforming(client, objectDef, rawObj, objProps);\n        if (strictNonNull === \"throw\" && !conforming) {\n            throw new Error(\"Unable to safely convert objects as some non nullable properties are null\");\n        }\n        else if (strictNonNull === \"drop\" && !conforming) {\n            continue;\n        }\n        let osdkObject = createOsdkObject(client, objectDef, rawObj);\n        if (interfaceApiName)\n            osdkObject = osdkObject.$as(interfaceApiName);\n        ret.push(osdkObject);\n    }\n    client.logger?.debug(`END convertWireToOsdkObjects()`);\n    return ret;\n}\n/**\n * Utility function that lets us take down selected property names from an interface\n * and convert them to an array of property names on an object.\n */\nfunction convertInterfacePropNamesToObjectPropNames(objectDef, interfaceApiName, ifacePropsToMap) {\n    return ifacePropsToMap.map((ifaceProp) => objectDef.interfaceMap[interfaceApiName][ifaceProp]);\n}\n/**\n * Takes a raw object from the wire (contextually as an interface) and\n * updates the fields to reflect the underlying objectDef instead\n * @param objectDef\n * @param interfaceApiName\n * @param client\n * @param rawObj\n */\nfunction reframeAsObjectInPlace(objectDef, interfaceApiName, rawObj) {\n    const newProps = {};\n    for (const [sptProp, regularProp] of Object.entries(objectDef.interfaceMap[interfaceApiName])) {\n        if (sptProp in rawObj) {\n            const value = rawObj[sptProp];\n            delete rawObj[sptProp];\n            if (value !== undefined) {\n                newProps[regularProp] = value;\n            }\n        }\n    }\n    Object.assign(rawObj, newProps);\n    if (!(objectDef.primaryKeyApiName in rawObj)) {\n        rawObj[objectDef.primaryKeyApiName] = rawObj.$primaryKey;\n    }\n}\nfunction isConforming(client, def, obj, propsToCheck) {\n    for (const propName of propsToCheck) {\n        if (def.properties[propName].nullable === false && obj[propName] == null) {\n            if (process.env.NODE_ENV !== \"production\") {\n                client.logger?.debug({\n                    obj: {\n                        $objectType: obj[\"$objectType\"],\n                        $primaryKey: obj[\"$primaryKey\"],\n                    },\n                }, `Found object that does not conform to its definition. Expected ${def.apiName}'s ${propName} to not be null.`);\n            }\n            return false;\n        }\n    }\n    return true;\n}\nfunction invariantInterfacesAsViews(objectDef, interfaceApiName, client) {\n    if (objectDef.interfaceMap?.[interfaceApiName] == null) {\n        const warning = \"Interfaces are only supported 'as views' but your metadata object is missing the correct information. This suggests your interfaces have not been migrated to the newer version yet and you cannot use this version of the SDK.\";\n        if (client.logger) {\n            client.logger.warn(warning);\n        }\n        else {\n            // eslint-disable-next-line no-console\n            console.error(`WARNING! ${warning}`);\n        }\n        throw new Error(warning);\n    }\n}\nfunction fixObjectPropertiesInPlace(objs, forceRemoveRid) {\n    for (const obj of objs) {\n        if (forceRemoveRid) {\n            delete obj.__rid;\n        }\n        if (obj.__rid) {\n            obj.$rid = obj.__rid;\n            delete obj.__rid;\n        }\n        // Backend returns as __apiName but we want to stick to $ structure\n        obj.$apiName = obj.__apiName;\n        // for now these are the same but when we start doing interface projections the $objectType will always be underlying and\n        // the $apiName will be for the current view (in current designs)\n        obj.$objectType = obj.__apiName;\n        // copying over for now as its always returned. In the future, this should just be inferred from underlying\n        obj.$primaryKey = obj.__primaryKey;\n        obj.$title = obj.__title;\n        // we don't want people to use these\n        delete obj.__apiName;\n        delete obj.__primaryKey;\n        delete obj.__title;\n    }\n}\n"],"mappings":"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","ignoreList":[]}