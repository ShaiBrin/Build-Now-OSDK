{"version":3,"file":"tsserver.js","names":["execaNode","findUpMultiple","EventEmitter","fs","path","pLocate","pMap","invariant","server","s","TsServerImpl","tsServerPath","nextSeq","subprocess","logger","constructor","start","ipc","serialization","isLevelEnabled","on","req","trace","info","emit","stop","connected","disconnect","getOneMessage","filter","requestFactory","#requestFactory","command","isResponse","args","makeRequest","sendOpenRequest","protocol","CommandTypes","Open","sendQuickInfoRequest","Quickinfo","isQuickInfoResponse","#makeRequest","seq","type","arguments","sendMessage","resp","undefined","startTsServer","getTsServerPath","process","env","NODE_ENV","nodeModuleDirs","cwd","import","meta","url","possibleTsServerPaths","dir","join","c","stat","isFile","e","isEvent","m","isProjectLoadingStart","event","isProjectLoadingEnd","requestSeq","request_seq"],"sources":["tsserver.js"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { execaNode } from \"execa\";\nimport { findUpMultiple } from \"find-up\";\nimport { EventEmitter } from \"node:events\";\nimport * as fs from \"node:fs/promises\";\nimport * as path from \"node:path\";\nimport pLocate from \"p-locate\";\nimport pMap from \"p-map\";\nimport invariant from \"tiny-invariant\";\nimport { server as s } from \"typescript\";\nclass TsServerImpl extends EventEmitter {\n    #tsServerPath;\n    #nextSeq = 1;\n    #subprocess;\n    #logger;\n    constructor(tsServerPath, logger) {\n        super();\n        this.#tsServerPath = tsServerPath;\n        this.#logger = logger;\n    }\n    get subprocess() {\n        return this.#subprocess;\n    }\n    async start() {\n        this.#subprocess = execaNode({\n            ipc: true,\n            serialization: \"json\",\n        }) `${this.#tsServerPath} --useNodeIpc`;\n        if (this.#logger.isLevelEnabled(\"trace\")) {\n            this.#subprocess.on(\"message\", (req) => {\n                this.#logger.trace({ req }, \"message received\");\n            });\n        }\n        this.#subprocess.on(\"exit\", () => {\n            this.#logger.info(\"tsserver exited\");\n            this.emit(\"exit\");\n        });\n        return this;\n    }\n    stop() {\n        if (this.#subprocess?.connected) {\n            this.#subprocess?.disconnect();\n        }\n    }\n    async getOneMessage(filter) {\n        return await this.subprocess.getOneMessage({ filter });\n    }\n    #requestFactory = (command, isResponse) => async (args) => {\n        return await this.#makeRequest(command, args, isResponse);\n    };\n    sendOpenRequest = this.#requestFactory(s.protocol.CommandTypes.Open);\n    sendQuickInfoRequest = this.#requestFactory(s.protocol.CommandTypes.Quickinfo, isQuickInfoResponse);\n    async #makeRequest(command, args, isResponse) {\n        const seq = this.#nextSeq++;\n        const req = {\n            type: \"request\",\n            command,\n            arguments: args,\n            seq,\n        };\n        this.#logger.trace({ req }, \"requesting\");\n        await this.#subprocess?.sendMessage(req);\n        if (isResponse) {\n            return {\n                req,\n                resp: await this.#subprocess?.getOneMessage({\n                    filter: isResponse,\n                }),\n            };\n        }\n        return { req, resp: undefined };\n    }\n}\nexport async function startTsServer(logger) {\n    const tsServerPath = await getTsServerPath();\n    invariant(tsServerPath != null);\n    return new TsServerImpl(tsServerPath, logger).start();\n}\nasync function getTsServerPath() {\n    const nodeModuleDirs = await findUpMultiple(\"node_modules\", {\n        cwd: import.meta.url,\n        type: \"directory\",\n    });\n    const possibleTsServerPaths = await pMap(nodeModuleDirs, (dir) => path.join(dir, \"typescript\", \"lib\", \"tsserver.js\"));\n    const tsServerPath = await pLocate([\"no\", ...possibleTsServerPaths], async (dir) => {\n        try {\n            const c = await fs.stat(dir);\n            return c.isFile();\n        }\n        catch (e) {\n            return false;\n        }\n    });\n    return tsServerPath;\n}\nexport function isEvent(m) {\n    return !!(m && typeof m === \"object\" && \"type\" in m\n        && m.type === \"event\");\n}\nexport function isResponse(m) {\n    return !!(m && typeof m === \"object\" && \"type\" in m\n        && m.type === \"response\");\n}\nexport function isProjectLoadingStart(m) {\n    return isEvent(m) && m.event === \"projectLoadingStart\";\n}\nexport function isProjectLoadingEnd(m) {\n    return isEvent(m) && m.event === \"projectLoadingFinish\";\n}\nexport function isQuickInfoResponse(m, requestSeq) {\n    return isResponse(m) && m.command === s.protocol.CommandTypes.Quickinfo\n        && (requestSeq == null || m.request_seq === requestSeq);\n}\n"],"mappings":"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","ignoreList":[]}