{"version":3,"file":"SimpleCache.js","names":["createSimpleCache","map","Map","fn","set","key","value","get","r","undefined","remove","delete","createSimpleAsyncCache","type","createCacheLocal","cache","WeakMap","inProgress","ret","getOrUndefined","k","v","e"],"sources":["SimpleCache.js"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nexport function createSimpleCache(map = new Map(), fn) {\n    function get(key) {\n        let r = map.get(key);\n        if (r === undefined && fn !== undefined) {\n            return set(key, fn(key));\n        }\n        else {\n            return r;\n        }\n    }\n    function set(key, value) {\n        map.set(key, value);\n        return value;\n    }\n    function remove(key) {\n        return map.delete(key);\n    }\n    return { get, set, remove };\n}\n/**\n * Create a new cache with an async factory function.\n * @param fn A factory function that will be used to create the value if it does not exist in the cache.\n * @returns\n */\nexport function createSimpleAsyncCache(type, fn, createCacheLocal = createSimpleCache) {\n    const cache = createCacheLocal((type === \"weak\" ? new WeakMap() : new Map()));\n    const inProgress = createCacheLocal((type === \"weak\" ? new WeakMap() : new Map()));\n    const ret = {\n        getOrUndefined: function getOrUndefined(key) {\n            return cache.get(key);\n        },\n        get: async function get(key) {\n            return cache.get(key) ?? inProgress.get(key)\n                ?? ret.set(key, fn(key));\n        },\n        set: async function set(k, v) {\n            // the `.set` happens first to prevent races.\n            try {\n                const r = await inProgress.set(k, v); // returns v\n                cache.set(k, r);\n                inProgress.remove(k);\n                return r;\n            }\n            catch (e) {\n                // we don't want to cache failures\n                inProgress.remove(k);\n                throw e;\n            }\n        },\n    };\n    return ret;\n}\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASA,iBAAiBA,CAACC,GAAG,GAAG,IAAIC,GAAG,CAAC,CAAC,EAAEC,EAAE,EAAE;EAUnD,SAASC,GAAGA,CAACC,GAAG,EAAEC,KAAK,EAAE;IACrBL,GAAG,CAACG,GAAG,CAACC,GAAG,EAAEC,KAAK,CAAC;IACnB,OAAOA,KAAK;EAChB;EAIA,OAAO;IAAEC,GAAG,EAhBZ,SAAAA,CAAaF,GAAG,EAAE;MACd,IAAIG,CAAC,GAAGP,GAAG,CAACM,GAAG,CAACF,GAAG,CAAC;MACpB,IAAIG,CAAC,KAAKC,SAAS,IAAIN,EAAE,KAAKM,SAAS,EAAE;QACrC,OAAOL,GAAG,CAACC,GAAG,EAAEF,EAAE,CAACE,GAAG,CAAC,CAAC;MAC5B,CAAC,MACI;QACD,OAAOG,CAAC;MACZ;IACJ,CAQY;IAAEJ,GAAG;IAAEM,MAAM,EAHzB,SAAAA,CAAgBL,GAAG,EAAE;MACjB,OAAOJ,GAAG,CAACU,MAAM,CAACN,GAAG,CAAC;IAC1B;EAC0B,CAAC;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,SAASO,sBAAsBA,CAACC,IAAI,EAAEV,EAAE,EAAEW,gBAAgB,GAAGd,iBAAiB,EAAE;EACnF,MAAMe,KAAK,GAAGD,gBAAgB,CAAED,IAAI,KAAK,MAAM,GAAG,IAAIG,OAAO,CAAC,CAAC,GAAG,IAAId,GAAG,CAAC,CAAE,CAAC;EAC7E,MAAMe,UAAU,GAAGH,gBAAgB,CAAED,IAAI,KAAK,MAAM,GAAG,IAAIG,OAAO,CAAC,CAAC,GAAG,IAAId,GAAG,CAAC,CAAE,CAAC;EAClF,MAAMgB,GAAG,GAAG;IACRC,cAAc,EAAE,SAAAA,CAAwBd,GAAG,EAAE;MACzC,OAAOU,KAAK,CAACR,GAAG,CAACF,GAAG,CAAC;IACzB,CAAC;IACDE,GAAG,EAAE,eAAAA,CAAmBF,GAAG,EAAE;MACzB,OAAOU,KAAK,CAACR,GAAG,CAACF,GAAG,CAAC,IAAIY,UAAU,CAACV,GAAG,CAACF,GAAG,CAAC,IACrCa,GAAG,CAACd,GAAG,CAACC,GAAG,EAAEF,EAAE,CAACE,GAAG,CAAC,CAAC;IAChC,CAAC;IACDD,GAAG,EAAE,eAAAA,CAAmBgB,CAAC,EAAEC,CAAC,EAAE;MAC1B;MACA,IAAI;QACA,MAAMb,CAAC,GAAG,MAAMS,UAAU,CAACb,GAAG,CAACgB,CAAC,EAAEC,CAAC,CAAC,CAAC,CAAC;QACtCN,KAAK,CAACX,GAAG,CAACgB,CAAC,EAAEZ,CAAC,CAAC;QACfS,UAAU,CAACP,MAAM,CAACU,CAAC,CAAC;QACpB,OAAOZ,CAAC;MACZ,CAAC,CACD,OAAOc,CAAC,EAAE;QACN;QACAL,UAAU,CAACP,MAAM,CAACU,CAAC,CAAC;QACpB,MAAME,CAAC;MACX;IACJ;EACJ,CAAC;EACD,OAAOJ,GAAG;AACd","ignoreList":[]}