{"version":3,"file":"Cache.js","names":["createClientCache","fn","cache","WeakMap","set","client","key","value","get","clientCacheKey","Map","r","undefined","remove","delete","createAsyncClientCache","createCacheLocal","inProgress","ret","getOrUndefined","k","v","e"],"sources":["Cache.js"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nexport function createClientCache(fn) {\n    const cache = new WeakMap();\n    function get(client, key) {\n        if (cache.get(client.clientCacheKey) == null) {\n            cache.set(client.clientCacheKey, new Map());\n        }\n        let r = cache.get(client.clientCacheKey).get(key);\n        if (r === undefined && fn !== undefined) {\n            return set(client, key, fn(client, key));\n        }\n        else {\n            return r;\n        }\n    }\n    function set(client, key, value) {\n        if (cache.get(client.clientCacheKey) == null) {\n            cache.set(client.clientCacheKey, new Map());\n        }\n        cache.get(client.clientCacheKey).set(key, value);\n        return value;\n    }\n    function remove(client, key) {\n        if (cache.get(client.clientCacheKey) == null)\n            return false;\n        return cache.get(client.clientCacheKey).delete(key);\n    }\n    return { get, set, remove };\n}\n/**\n * @internal\n * Create a new cache with an async factory function.\n * @param fn A factory function that will be used to create the value if it does not exist in the cache.\n * @returns\n */\nexport function createAsyncClientCache(fn, createCacheLocal = createClientCache) {\n    const cache = createCacheLocal();\n    const inProgress = createCacheLocal();\n    const ret = {\n        getOrUndefined: function getOrUndefined(client, key) {\n            return cache.get(client, key);\n        },\n        get: async function get(client, key) {\n            return cache.get(client, key) ?? inProgress.get(client, key)\n                ?? ret.set(client, key, fn(client, key));\n        },\n        set: async function set(client, k, v) {\n            // the `.set` happens first to prevent races.\n            try {\n                const r = await inProgress.set(client, k, v); // returns v\n                cache.set(client, k, r);\n                inProgress.remove(client, k);\n                return r;\n            }\n            catch (e) {\n                // we don't want to cache failures\n                inProgress.remove(client, k);\n                throw e;\n            }\n        },\n    };\n    return ret;\n}\n"],"mappings":"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","ignoreList":[]}