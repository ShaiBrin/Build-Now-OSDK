{"version":3,"file":"common.js","names":["processRevocationResponse","revocationRequest","invariant","TypedEventTarget","throwIfError","CustomEvent","globalThis","localStorage","saveLocal","client","x","setItem","client_id","JSON","stringify","removeLocal","removeItem","readLocal","parse","getItem","common","as","_signIn","oauthHttpOptions","refresh","token","eventTarget","makeTokenAndSaveRefresh","resp","type","refresh_token","expires_in","access_token","process","env","NODE_ENV","expires_at","Date","now","dispatchTypedEvent","detail","refreshTimeout","rmTimeout","clearTimeout","restartRefreshTimer","evt","setTimeout","pendingSignIn","signIn","undefined","addEventListener","getTokenOrUndefined","getToken","Object","assign","signOut","result","Event","bind","removeEventListener","createAuthorizationServer","ctxPath","url","issuer","URL","token_endpoint","authorization_endpoint","revocation_endpoint"],"sources":["common.js"],"sourcesContent":["/*\n * Copyright 2024 Palantir Technologies, Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { processRevocationResponse, revocationRequest } from \"oauth4webapi\";\nimport invariant from \"tiny-invariant\";\nimport { TypedEventTarget } from \"typescript-event-target\";\nimport { throwIfError } from \"./throwIfError.js\";\n// Node 18 is supposed to have a `CustomEvent` but it is not exposed on `globalThis`\n// which creates a problem for making a single codebase for node and browser. This polyfill works around it\nconst CustomEvent = process.env.TARGET === \"browser\"\n    ? globalThis.CustomEvent\n    : globalThis.CustomEvent\n        ?? class CustomEvent extends Event {\n            #detail;\n            constructor(type, options) {\n                super(type, options);\n                this.#detail = options?.detail ?? null;\n            }\n            get detail() {\n                return this.#detail;\n            }\n        };\nconst localStorage = globalThis.localStorage;\nexport function saveLocal(client, x) {\n    // MUST `localStorage?` as nodejs does not have localStorage\n    localStorage?.setItem(`@osdk/oauth : refresh : ${client.client_id}`, JSON.stringify(x));\n}\nexport function removeLocal(client) {\n    // MUST `localStorage?` as nodejs does not have localStorage\n    localStorage?.removeItem(`@osdk/oauth : refresh : ${client.client_id}`);\n}\nexport function readLocal(client) {\n    return JSON.parse(\n    // MUST `localStorage?` as nodejs does not have localStorage\n    localStorage?.getItem(`@osdk/oauth : refresh : ${client.client_id}`)\n        ?? \"{}\");\n}\nexport function common(client, as, _signIn, oauthHttpOptions, refresh) {\n    let token;\n    const eventTarget = new TypedEventTarget();\n    function makeTokenAndSaveRefresh(resp, type) {\n        const { refresh_token, expires_in, access_token } = resp;\n        invariant(expires_in != null);\n        saveLocal(client, { refresh_token });\n        token = {\n            refresh_token,\n            expires_in,\n            access_token,\n            expires_at: Date.now() + expires_in * 1000,\n        };\n        eventTarget.dispatchTypedEvent(type, new CustomEvent(type, { detail: token }));\n        return token;\n    }\n    let refreshTimeout;\n    function rmTimeout() {\n        if (refreshTimeout)\n            clearTimeout(refreshTimeout);\n    }\n    function restartRefreshTimer(evt) {\n        if (refresh) {\n            rmTimeout();\n            refreshTimeout = setTimeout(refresh, evt.detail.expires_in * 1000 - 60 * 1000);\n        }\n    }\n    async function signOut() {\n        invariant(token, \"not signed in\");\n        const result = await processRevocationResponse(await revocationRequest(as, client, token.access_token, oauthHttpOptions));\n        rmTimeout();\n        // Clean up\n        removeLocal(client);\n        token = undefined;\n        throwIfError(result);\n        eventTarget.dispatchTypedEvent(\"signOut\", new Event(\"signOut\"));\n    }\n    let pendingSignIn;\n    async function signIn() {\n        if (pendingSignIn) {\n            return pendingSignIn;\n        }\n        try {\n            pendingSignIn = _signIn();\n            return await pendingSignIn;\n        }\n        finally {\n            pendingSignIn = undefined;\n        }\n    }\n    eventTarget.addEventListener(\"signIn\", restartRefreshTimer);\n    eventTarget.addEventListener(\"refresh\", restartRefreshTimer);\n    function getTokenOrUndefined() {\n        if (!token || Date.now() >= token.expires_at) {\n            return undefined;\n        }\n        return token?.access_token;\n    }\n    const getToken = Object.assign(async function getToken() {\n        if (!token || Date.now() >= token.expires_at) {\n            token = await signIn();\n        }\n        return token?.access_token;\n    }, {\n        signIn,\n        refresh,\n        signOut,\n        rmTimeout,\n        getTokenOrUndefined,\n        addEventListener: eventTarget.addEventListener.bind(eventTarget),\n        removeEventListener: eventTarget.removeEventListener.bind(eventTarget),\n    });\n    return { getToken, makeTokenAndSaveRefresh };\n}\nexport function createAuthorizationServer(ctxPath, url) {\n    const issuer = `${new URL(ctxPath, url)}`;\n    return {\n        token_endpoint: `${issuer}/api/oauth2/token`,\n        authorization_endpoint: `${issuer}/api/oauth2/authorize`,\n        revocation_endpoint: `${issuer}/api/oauth2/revoke_token`,\n        issuer,\n    };\n}\n"],"mappings":"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","ignoreList":[]}